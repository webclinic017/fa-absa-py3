[_brokerage_risk_exts]FCurrency:effectivePrice = nil;
[_brokerage_risk_exts]FInstrument:effectivePrice = switch(collateralPosition <> 0, 
  true->shunt(priceCapCondition == nil, 
    true->theoreticalOrMarketPrice, 
    false->min(priceCap, theoreticalOrMarketPrice)), 
  default->nil);
[_brokerage_risk_exts]FSingleInstrumentAndTrades:effectivePrice = convertToCurrency(instrument:effectivePrice [portfolio, positionObject], portfolioFxRates, displayCurrencySymbol, filterUnit);