[_brokerage_risk_exts]FInstrument:effectiveQuantity = shunt(quantityCapCondition == nil, 
  true->netCollateralPosition, 
  false->min(quantityCap, netCollateralPosition));
[_brokerage_risk_exts]FSingleInstrumentAndTrades:effectiveQuantity = instrument:effectiveQuantity [portfolio, positionObject];