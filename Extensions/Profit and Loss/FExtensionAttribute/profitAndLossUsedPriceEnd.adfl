[Profit and Loss]FInstrument:profitAndLossUsedPriceEnd = shunt(profitAndLossEndDate == valuationSystemDate, 
  true->select(useBidAskValuation, 
    true->bidAskCalculation(doubleSumOf(positionTradeQuantities), markToMarketSuggestedSpotPriceBidAsk, valuationSystemDate, accountingParameters), 
    default->markToMarketSuggestedSpotPrice), 
  default->object:profitAndLossUsedPrice [positionObject, valuationBaseDateTimeInput = profitAndLossEndDate]);
[Profit and Loss]FPriceAggregate:profitAndLossUsedPriceEnd = shunt(singleInstrumentAndTrades, 
  nil->nil, 
  default->singleInstrumentAndTrades :* "profitAndLossUsedPriceEnd");
[Profit and Loss]FSingleInstrumentAndTrades:profitAndLossUsedPriceEnd = instrument :* "profitAndLossUsedPriceEnd" [profitAndLossEndDate, positionObject];
[Profit and Loss]FTradeRow:profitAndLossUsedPriceEnd = instrument :* "profitAndLossUsedPriceEnd" [profitAndLossEndDate, positionObject];