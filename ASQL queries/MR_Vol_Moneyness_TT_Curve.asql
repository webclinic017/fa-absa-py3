/*
'''
Purpose                 :Market Risk feed files
Department and Desk     :IT
Requester:              :Natalie Austin
Developer               :Douglas Finkel / Henk Nel
CR Number               :264536
'''
*/
Select
    'Create File' 'Process', 
    ael_s(,'MR_Vol_Moneyness_TT_Curve.OpenFile',@1_path{'c:\'},@2_FileName{'FileName.csv'})    'BuildConfirmation'
Into
    macro
From
                serverdata s
Where
                s.srdnbr > 0

Select vol.seqnbr
Into temp
From
    Context c,
    ContextLink cl,
    Volatility vol
Where
    c.name = 'ACMB Global'
and c.seqnbr = cl.context_seqnbr
and cl.name = vol.vol_name
and cl.mapping_type in ('Val Group','Instrument')
and vol.risk_type in ('IR Vol')
and vol.bond_vol_type not in ('Price')

Select vol.seqnbr
Into temp
From temp tmp, 
    Volatility vol,
    Volatility par
Where
    par.seqnbr = tmp.seqnbr
    and par.und_vol_seqnbr = vol.seqnbr

Select
    'Write File' 'Process', 
    ael_s(vol,'MR_Vol_Moneyness_TT_Curve.Write',@1_path{'c:\'},@2_FileName{'FileName.csv'})     'BuildConfirmation'
Into
    macro
From
    temp tmp, 
    volatility vol
Where
    vol.seqnbr = tmp.seqnbr
 
Select
    'Close File'    'Process', 
    'Successful'	'BuildConfirmation'
Into
    Macro
From
	serverdata s
Where
	s.srdnbr > 0

Select * From Macro
Where Process In ('Create File','Close File')
